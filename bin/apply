#!/bin/bash
set -euo pipefail
set -x

if [ "${TRAVIS_BRANCH}" == "master" ] || [[ "${TRAVIS_BRANCH}" =~ ${LABELS_BRANCH:-^labels-ci} ]]; then
  go get -u github.com/tonglil/labeler

  labeler apply labels.yaml -l 9

  if [ "${LABELS_TRIM:-0}" -eq 1 ]; then
    labeler trim labels.yaml

    diff=$(git diff --name-only -- labels.yaml)
    if [ "$diff" == "labels.yaml" ]; then
      # https://docs.travis-ci.com/user/deployment/custom/
      # Start the ssh agent
      eval "$(ssh-agent -s)"
      # This private deploy key should have push access
      openssl aes-256-cbc -K $encrypted_8ac6028fa38c_key -iv $encrypted_8ac6028fa38c_iv -in travis_labeler.enc -out deploy_key -d
      chmod 600 deploy_key
      ssh-add deploy_key

      git config user.email "travis@ci"
      git config user.name "Travis CI"

      git remote add ci "git@github.com:$TRAVIS_REPO_SLUG.git"

      branch="ci-trim-labels_${TRAVIS_BRANCH}_$(date +%Y-%m-%d-%H-%M-%S)"
      git checkout -b "$branch"
      git add labels.yaml
      git commit -m 'GENERATED BY CI: trim labels.yaml'
      git push --set-upstream ci "$branch"

      if [ "${LABELS_PR:-0}" -eq 1 ]; then
        go get -u github.com/github/hub

        cat <<EOF > PATCH.md
        [ci] Trimmed labels.yaml

        Automatically generated by \`labeler trim labels.yaml\`.
        https://github.com/tonglil/labeler
EOF

        #{
          #echo -e "[ci] Trimmed labels.yaml\n"
          #echo -e "Automatically generated by \`labeler trim labels.yaml\`."
          #echo -e "https://github.com/tonglil/labeler"
        #} > PATCH.md

        cat PATCH.md

        #hub pull-request -F PATCH.md -b "${TRAVIS_BRANCH}" -h "$branch"
      fi
    fi
  fi
fi
