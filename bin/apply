#!/bin/bash
set -euo pipefail
set -x

if [ "${TRAVIS_BRANCH}" == "master" ] || [[ "${TRAVIS_BRANCH}" =~ ${LABELS_BRANCH:-^auto-ci} ]]; then
  go get -u github.com/tonglil/labeler

  labeler apply labels.yaml -l 9

  if [ "${LABELS_TRIM:-0}" -eq 1 ]; then
    labeler trim labels.yaml

    diff=$(git diff --name-only -- labels.yaml)
    if [ "$diff" == "labels.yaml" ]; then
      go get -u github.com/github/hub

      {
        echo -e "[ci] Trimmed labels.yaml\n";
        echo -e "Automatically generated diff:\n\`\`\`";
        git diff -- labels.yaml;
        echo -e "\n\`\`\`";
      } > "${LABELS_PR}"

      #echo -e "[ci] Trimmed labels.yaml\n" > "${LABELS_PR}"
      #echo -e "Automatically generated diff:\n\`\`\`" >> "${LABELS_PR}"
      #git diff -- labels.yaml >> "${LABELS_PR}"
      #echo -e "\n\`\`\`" >> "${LABELS_PR}"

      cat "${LABELS_PR}"

      # https://docs.travis-ci.com/user/deployment/custom/
      # Start the ssh agent
      #eval "$(ssh-agent -s)"
      ## This key should have push access
      #openssl aes-256-cbc -K $encrypted_8ac6028fa38c_key -iv $encrypted_8ac6028fa38c_iv -in travis_labeler.enc -out travis_labeler -d
      #chmod 600 travis_labeler
      #ssh-add travis_labeler

      git config user.email "travis@ci"
      git config user.name "Travis CI"

      #git remote add ci "git@github.com:$TRAVIS_REPO_SLUG.git"

      branch="ci-${TRAVIS_BRANCH}-labels-cleanup-$(date +%Y-%m-%d-%H-%M-%S)"
      git checkout -b "$branch"
      git add labels.yaml
      git commit -m 'GENERATED BY CI: trim labels.yaml'
      hub push --set-upstream origin "$branch"

      #hub pull-request -F PATCH.md -b "${TRAVIS_BRANCH}" -h "$branch"
    fi
  fi
fi
