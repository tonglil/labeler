#!/bin/bash
set -euo pipefail
set -x

if [ "${TRAVIS_BRANCH}" == "master" ] || [[ "${TRAVIS_BRANCH}" == "${LABELS_BRANCH:-'auto-ci*'}" ]]; then
  go get -u github.com/tonglil/labeler

  labeler apply labels.yaml -l 9

  if [ "${LABELS_TRIM}" -eq 0 ]; then
    exit 0
  fi

  labeler trim labels.yaml -l 9

  diff=$(git diff --name-only labels.yaml)
  if [ "$diff" == "labels.yaml" ]; then
    branch="ci-${TRAVIS_BRANCH}-labels-cleanup-$(date +%Y-%m-%d-%H-%M-%S)"
    git checkout -b "$branch"
    git add labels.yaml
    git commit -m 'GENERATED BY CI: trim labels.yaml'
    git push --set-upstream origin "$branch"
  fi
fi
