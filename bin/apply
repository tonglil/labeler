#!/bin/bash
set -euo pipefail
set -x

if [ "${TRAVIS_BRANCH}" == "master" ] || [[ "${TRAVIS_BRANCH}" =~ ${LABELS_BRANCH:-^auto-ci} ]]; then
  go get -u github.com/tonglil/labeler

  labeler apply labels.yaml -l 9

  if [ "${LABELS_TRIM:-0}" -eq 1 ]; then
    labeler trim labels.yaml

    diff=$(git diff --name-only -- labels.yaml)
    if [ "$diff" == "labels.yaml" ]; then
      changes=$(git diff -- labels.yaml)

      openssl aes-256-cbc -K $encrypted_8ac6028fa38c_key -iv $encrypted_8ac6028fa38c_iv -in travis_labeler.enc -out travis_labeler -d
      # https://docs.travis-ci.com/user/deployment/custom/
      # Start the ssh agent
      eval "$(ssh-agent -s)"
      # This key should have push access
      chmod 600 travis_labeler
      ssh-add travis_labeler

      git config user.email "travis@ci"
      git config user.name "Travis CI"

      git remote add ci "git@github.com:$TRAVIS_REPO_SLUG.git"

      branch="ci-${TRAVIS_BRANCH}-labels-cleanup-$(date +%Y-%m-%d-%H-%M-%S)"
      git checkout -b "$branch"
      git add labels.yaml
      git commit -m 'GENERATED BY CI: trim labels.yaml'
      git push --set-upstream ci "$branch"

      curl "https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls" \
        -H "Authorization: token $GITHUB_TOKEN" \
        -X POST \
        --data @- << EOF
{
  "title": "[ci] Trimmed labels.yaml",
  "body": "Automated:\n```$changes```",
  "head": "$branch",
  "base": "${TRAVIS_BRANCH}"
}
EOF
    fi
  fi
fi
